<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vovinam Professional Arena - Perfect View</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Montserrat:wght@900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root { --bg-gradient: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }
        
        body {
            font-family: 'Oswald', sans-serif;
            background: var(--bg-gradient);
            color: white; margin: 0; overflow: hidden;
        }

        /* Container chính giúp căn giữa hoàn hảo */
        #mainUI {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Căn giữa theo chiều dọc */
            transition: all 0.5s ease;
        }

        .athlete-banner {
            background: linear-gradient(90deg, transparent, #dc2626 20%, #dc2626 80%, transparent);
            width: 100%; text-align: center; padding: 1.5rem 0; font-family: 'Montserrat', sans-serif;
            font-size: 5rem; font-weight: 900; text-transform: uppercase; margin: 1.5rem 0;
            text-shadow: 0 10px 20px rgba(0,0,0,0.6);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .main-display {
            position: relative; width: 1000px; height: 460px; display: flex; align-items: center; justify-content: center;
            background: rgba(255, 255, 255, 0.02); border-radius: 70px; border: 12px solid #facc15;
            box-shadow: 0 0 120px rgba(250, 204, 21, 0.2);
        }

        .total-score { font-family: 'Montserrat', sans-serif; font-size: 380px; font-weight: 900; color: #4ade80; line-height: 1; }

        .judges-dock { display: flex; justify-content: center; gap: 20px; margin-top: 2.5rem; width: 95%; }
        .judge-card { background: rgba(15, 23, 42, 0.95); border-bottom: 10px solid #facc15; min-width: 170px; padding: 20px 10px; text-align: center; border-radius: 25px; }
        .excluded { color: #ef4444 !important; text-decoration: line-through; opacity: 0.3; }

        /* KHI Ở CHẾ ĐỘ FULLSCREEN */
        #mainUI:fullscreen .admin-btn { display: none; }
        #mainUI:-webkit-full-screen .admin-btn { display: none; }
        
        /* Đảm bảo khi fullscreen, khoảng cách được nới rộng ra cho đẹp */
        #mainUI:fullscreen { padding: 2rem 0; }

        #adminOverlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px);
        }
        .admin-window { background: #0f172a; width: 95%; max-width: 1100px; border: 4px solid #facc15; border-radius: 40px; padding: 40px; }

        /* Judge Mobile */
        .judge-mode { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; background: #020617; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; max-width: 360px; }
        .key { background: #1e293b; padding: 25px; border-radius: 20px; font-size: 1.8rem; font-weight: bold; text-align: center; border-bottom: 5px solid #0f172a; }
        .key:active { transform: translateY(3px); border-bottom: 0; background: #334155; }
    </style>
</head>
<body>

    <div id="mainUI">
        <div class="text-center">
            <h1 id="dispEvent" class="text-4xl font-black text-yellow-400 tracking-[0.3em] uppercase italic">GIẢI VÔ ĐỊCH VOVINAM</h1>
            <p id="dispForm" class="text-2xl text-white/40 italic mt-2 tracking-widest uppercase">Nội dung thi đấu</p>
        </div>

        <div class="athlete-banner" id="dispAthlete">TÊN VẬN ĐỘNG VIÊN</div>

        <div class="main-display">
            <div class="absolute -top-10 bg-yellow-500 text-black px-16 py-2 font-black rounded-full text-2xl shadow-2xl uppercase">Tổng điểm</div>
            <div id="dispTotal" class="total-score">0</div>
        </div>

        <div id="judgeArea" class="judges-dock"></div>

        <button onclick="toggleAdmin(true)" class="admin-btn fixed bottom-10 right-10 px-10 py-5 bg-yellow-500 text-black font-black rounded-2xl shadow-2xl hover:scale-105 transition-all uppercase text-lg">
            ⚙️ Cấu hình
        </button>
    </div>

    <div id="adminOverlay">
        <div class="admin-window text-white">
            <div class="flex justify-between items-center mb-8 border-b border-yellow-500/20 pb-4">
                <h2 class="text-4xl font-black text-yellow-500 italic uppercase">Điều hành giải đấu</h2>
                <div class="flex gap-4">
                    <button onclick="toggleFullscreen()" class="bg-indigo-600 px-6 py-3 rounded-xl font-bold uppercase text-sm hover:bg-indigo-500">Bật Toàn Màn Hình TV</button>
                    <button onclick="toggleAdmin(false)" class="text-6xl">&times;</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-10">
                <div class="space-y-6">
                    <label class="text-gray-400 text-sm font-bold block mb-[-15px]">TÊN GIẢI & VĐV</label>
                    <input type="text" id="inpEvent" placeholder="TÊN GIẢI ĐẤU" class="w-full p-4 bg-slate-800 rounded-xl text-xl font-bold outline-none border border-slate-700 focus:border-yellow-500">
                    <input type="text" id="inpAthlete" placeholder="TÊN VẬN ĐỘNG VIÊN" class="w-full p-4 bg-slate-800 rounded-xl text-xl font-bold outline-none border border-slate-700 focus:border-yellow-500">
                    <div class="grid grid-cols-2 gap-4">
                        <button id="m3" onclick="setMode(3)" class="py-5 rounded-2xl font-black text-xl border-2 transition-all">3 GIÁM ĐỊNH</button>
                        <button id="m5" onclick="setMode(5)" class="py-5 rounded-2xl font-black text-xl border-2 transition-all">5 GIÁM ĐỊNH</button>
                    </div>
                    <button onclick="resetMatch()" class="w-full bg-green-600 py-8 rounded-3xl font-black text-3xl shadow-xl hover:bg-green-500 uppercase transition-all">Trận Tiếp Theo</button>
                </div>
                <div class="bg-white/5 p-6 rounded-3xl border border-white/10">
                    <p class="text-yellow-400 font-bold mb-4 uppercase tracking-widest text-center">Mã kết nối giám định</p>
                    <div id="judgeConnectArea" class="grid grid-cols-2 gap-3 overflow-y-auto max-h-[350px]"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, remove, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwnuQ7R7yVrkqzgKASBdqgI3ZWK7yE4Mc",
            authDomain: "thiquyen-f4a04.firebaseapp.com",
            projectId: "thiquyen-f4a04",
            databaseURL: "https://thiquyen-f4a04-default-rtdb.asia-southeast1.firebasedatabase.app" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const matchRef = ref(db, `vovinam/final_perfect/match`);
        const votesRef = ref(db, `vovinam/final_perfect/votes`);

        const urlParams = new URLSearchParams(window.location.search);
        const role = urlParams.get('role');
        const judgeId = urlParams.get('id');

        // CHẾ ĐỘ GIÁM ĐỊNH (MOBILE)
        if (role === 'judge') {
            document.body.innerHTML = `
                <div class="judge-mode">
                    <div class="text-yellow-500 font-bold mb-1 uppercase tracking-widest">Giám định ${judgeId}</div>
                    <div id="jAthlete" class="text-4xl font-black mb-8 uppercase text-white text-center">--</div>
                    <div class="bg-slate-800 rounded-[40px] w-full max-w-[360px] p-12 mb-8 text-center shadow-2xl border-b-8 border-slate-900">
                        <div id="jScore" class="text-9xl font-black text-green-400">0</div>
                    </div>
                    <div class="keypad">
                        ${[7,8,9,4,5,6,1,2,3].map(n => `<div class="key" onclick="pressKey(${n})">${n}</div>`).join('')}
                        <div class="key bg-red-900/50" onclick="pressKey('C')">C</div>
                        <div class="key" onclick="pressKey(0)">0</div>
                        <div class="key bg-green-700" onclick="submitScore()">OK</div>
                    </div>
                </div>`;
            let cur = "";
            window.pressKey = (n) => {
                if(n === 'C') cur = "";
                else { if(cur.length < 3) cur += n; if(parseInt(cur) > 100) cur = "100"; }
                document.getElementById('jScore').innerText = cur || "0";
            };
            window.submitScore = () => {
                if(!cur) return;
                set(ref(db, `vovinam/final_perfect/votes/gd${judgeId}`), { score: parseInt(cur) });
                alert("Đã gửi điểm: " + cur);
            };
            onValue(matchRef, snap => document.getElementById('jAthlete').innerText = (snap.val() || {}).athlete || "Chờ...");
        } 
        
        // CHẾ ĐỘ HIỂN THỊ CHÍNH
        else {
            window.toggleAdmin = (s) => document.getElementById('adminOverlay').style.display = s ? 'flex' : 'none';
            window.toggleFullscreen = () => {
                const elem = document.getElementById('mainUI');
                if (!document.fullscreenElement) elem.requestFullscreen().catch(err => alert(err.message));
                else document.exitFullscreen();
            };
            window.copyLink = (id) => {
                const url = window.location.origin + window.location.pathname + `?role=judge&id=${id}`;
                navigator.clipboard.writeText(url);
                alert(`Đã copy link GĐ ${id}`);
            };

            onValue(matchRef, snap => {
                const d = snap.val() || {};
                const mode = d.mode || 3;
                document.getElementById('dispEvent').innerText = d.event || "GIẢI VÔ ĐỊCH VOVINAM";
                document.getElementById('dispAthlete').innerText = d.athlete || "TÊN VẬN ĐỘNG VIÊN";
                document.getElementById('dispTotal').innerText = d.total || 0;

                const area = document.getElementById('judgeArea'); area.innerHTML = "";
                const connectArea = document.getElementById('judgeConnectArea'); connectArea.innerHTML = "";
                
                let scs = [];
                for(let i=1; i<=mode; i++) scs.push({id: i, val: d[`gd${i}`] || 0});

                let maxId = -1, minId = -1;
                if(mode === 5) {
                    let v = scs.filter(x => x.val > 0);
                    if(v.length === 5) {
                        let s = [...v].sort((a,b) => a.val - b.val);
                        minId = s[0].id; maxId = s[4].id;
                    }
                }

                scs.forEach(s => {
                    const isEx = (s.id === maxId || s.id === minId);
                    area.innerHTML += `
                        <div class="judge-card">
                            <span class="text-6xl font-black block ${isEx ? 'excluded' : ''}">${s.val > 0 ? s.val : '--'}</span>
                            <span class="text-sm font-bold text-yellow-500 uppercase">Giám định ${s.id}</span>
                        </div>`;
                    
                    const url = window.location.origin + window.location.pathname + `?role=judge&id=${s.id}`;
                    connectArea.innerHTML += `
                        <div class="bg-slate-800 p-3 rounded-2xl flex flex-col items-center">
                            <div id="qr${s.id}" class="bg-white p-1 rounded-lg"></div>
                            <button onclick="copyLink(${s.id})" class="mt-2 bg-indigo-600 px-3 py-1 rounded text-[10px] font-bold uppercase">Copy Link GĐ${s.id}</button>
                        </div>`;
                    setTimeout(() => new QRCode(document.getElementById(`qr${s.id}`), {text: url, width: 80, height: 80}), 10);
                });

                document.getElementById('m3').className = mode === 3 ? "py-5 rounded-2xl font-black text-xl border-yellow-500 bg-yellow-500 text-black" : "py-5 rounded-2xl font-black text-xl border-slate-700 text-slate-500";
                document.getElementById('m5').className = mode === 5 ? "py-5 rounded-2xl font-black text-xl border-yellow-500 bg-yellow-500 text-black" : "py-5 rounded-2xl font-black text-xl border-slate-700 text-slate-500";
            });

            onValue(votesRef, snap => {
                const v = snap.val() || {};
                get(matchRef).then(mSnap => {
                    const m = mSnap.val() || {};
                    const mode = m.mode || 3;
                    let cur = []; let up = {};
                    for(let i=1; i<=mode; i++) if(v[`gd${i}`]) { up[`gd${i}`] = v[`gd${i}`].score; cur.push(v[`gd${i}`].score); }
                    if(cur.length === mode) {
                        let total = 0;
                        if(mode === 3) total = cur.reduce((a,b) => a+b, 0);
                        else { let s = [...cur].sort((a,b)=>a-b); total = s[1]+s[2]+s[3]; }
                        up.total = total; update(matchRef, up);
                    }
                });
            });

            window.setMode = (m) => {
                set(matchRef, {mode: m, event: document.getElementById('inpEvent').value, athlete: document.getElementById('inpAthlete').value, total: 0});
                remove(votesRef);
            };
            window.resetMatch = () => {
                remove(votesRef);
                update(matchRef, {gd1:0, gd2:0, gd3:0, gd4:0, gd5:0, total:0});
            };
            document.getElementById('inpEvent').oninput = e => update(matchRef, {event: e.target.value});
            document.getElementById('inpAthlete').oninput = e => update(matchRef, {athlete: e.target.value});
        }
    </script>
</body>
</html>
